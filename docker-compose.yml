# ==========================================
# Docker Compose é…ç½®æª”æ¡ˆ
# ==========================================
# é€™å€‹æª”æ¡ˆå®šç¾©äº†å¤šå€‹æœå‹™çš„é…ç½®ï¼Œä½¿ç”¨ docker-compose å¯ä»¥ä¸€æ¬¡å•Ÿå‹•æ‰€æœ‰æœå‹™

version: '3.8'

services:
  # ========== MinIO å°è±¡å­˜å„²æœå‹™ ==========
  minio:
    image: minio/minio:latest
    container_name: minio
    ports:
      - "9000:9000" # MinIO API ç«¯å£
      - "9001:9001" # MinIO ç®¡ç†æ§åˆ¶å°ç«¯å£
    environment:
      # å¾ .env æª”æ¡ˆè®€å–ï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨é è¨­å€¼
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:-minioadmin}
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data # æŒä¹…åŒ–æ•¸æ“š
    networks:
      - app-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ========== Django å¾Œç«¯æœå‹™ ==========
  backend:
    build: .
    container_name: django-backend
    ports:
      - "30000:30000" # API ç«¯å£
    env_file:
      - .env # è¼‰å…¥ .env æª”æ¡ˆä¸­çš„æ‰€æœ‰ç’°å¢ƒè®Šæ•¸
    environment:
      # MinIO é…ç½®ï¼ˆDocker å…§éƒ¨ä½¿ç”¨æœå‹™åç¨±ï¼‰
      # é€™è£¡æœƒè¦†è“‹ .env ä¸­çš„ MINIO_ENDPOINTï¼Œå› ç‚ºåœ¨ Docker ç¶²è·¯ä¸­éœ€è¦ä½¿ç”¨æœå‹™åç¨±
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
      MINIO_BUCKET_NAME: ${MINIO_BUCKET_NAME:-processed-images}
      MINIO_SECURE: "False"

      # AI å¾Œç«¯é…ç½®
      # å¦‚æœ AI æœå‹™ä¹Ÿåœ¨ Docker ä¸­ï¼Œä½¿ç”¨æœå‹™åç¨±
      # å¦‚æœåœ¨å®¿ä¸»æ©Ÿä¸Šï¼Œä½¿ç”¨ host.docker.internal (Mac/Windows) æˆ– 172.17.0.1 (Linux)
      AI_BACKEND_URL: ${AI_BACKEND_URL:-http://host.docker.internal:8002/api/remove_bg}

      # Django é…ç½®
      DEBUG: ${DEBUG:-False}
      DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY:-change-this-secret-key-in-production}

      # é–‹ç™¼æ¨¡å¼é…ç½®ï¼ˆå•Ÿç”¨ hot reloadï¼‰
      # è¨­ç‚º true æ™‚ä½¿ç”¨ Django runserver ä¸¦æ›è¼‰ç¨‹å¼ç¢¼ç›®éŒ„
      # è¨­ç‚º false æ™‚ä½¿ç”¨ Gunicorn ç”Ÿç”¢ä¼ºæœå™¨
      DJANGO_DEV_MODE: ${DJANGO_DEV_MODE:-false}
    volumes:
      # æ›è¼‰ç¨‹å¼ç¢¼ç›®éŒ„ä»¥æ”¯æ´ hot reloadï¼ˆé–‹ç™¼æ¨¡å¼ï¼‰
      - ./api:/app/api
      - ./config:/app/config
      - ./manage.py:/app/manage.py
      # æ—¥èªŒç›®éŒ„
      - ./logs:/app/logs
    # æ ¹æ“š DJANGO_DEV_MODE ç’°å¢ƒè®Šæ•¸æ±ºå®šå•Ÿå‹•å‘½ä»¤
    # é–‹ç™¼æ¨¡å¼ï¼šä½¿ç”¨ Django runserverï¼ˆæ”¯æ´ hot reloadï¼‰
    # ç”Ÿç”¢æ¨¡å¼ï¼šä½¿ç”¨ Dockerfile ä¸­çš„é è¨­å‘½ä»¤ï¼ˆGunicornï¼‰
    command: >
      sh -c "
        if [ \"$$DJANGO_DEV_MODE\" = \"true\" ]; then
          echo 'ğŸ”§ é–‹ç™¼æ¨¡å¼ï¼šHot Reload å·²å•Ÿç”¨';
          echo 'â³ ç­‰å¾… MinIO æœå‹™...';
          sleep 5;
          echo 'ğŸ”„ é‹è¡Œæ•¸æ“šåº«é·ç§»...';
          python3 manage.py migrate --noinput;
          echo 'ğŸš€ å•Ÿå‹• Django é–‹ç™¼ä¼ºæœå™¨...';
          python3 manage.py runserver 0.0.0.0:30000;
        else
          echo 'ğŸš€ ç”Ÿç”¢æ¨¡å¼ï¼šä½¿ç”¨ Gunicorn';
          echo 'â³ ç­‰å¾… MinIO æœå‹™...';
          sleep 5;
          echo 'ğŸ”„ é‹è¡Œæ•¸æ“šåº«é·ç§»...';
          python3 manage.py migrate --noinput;
          echo 'âœ… å•Ÿå‹• Gunicorn ä¼ºæœå™¨...';
          gunicorn config.wsgi:application --bind 0.0.0.0:30000 --workers 4 --timeout 300;
        fi
      "
    depends_on:
      - minio
    networks:
      - app-network
    restart: unless-stopped

# ========== ç¶²çµ¡é…ç½® ==========
networks:
  app-network:
    driver: bridge

# ========== æ•¸æ“šå·é…ç½® ==========
volumes:
  minio_data:
    driver: local
